# 一括検索キーワード生成機能

このドキュメントでは、バックエンドに統合された一括検索キーワード生成機能の使用方法について説明します。

## 概要

この機能は、複数の型番から最適な検索キーワードを一括で生成するためのものです。Perplexity AIのAPIを使用して、型番から商品の特徴を抽出し、検索に最適なキーワードを生成します。

### 処理の流れ

1. 入力された型番を前処理して、番号付けや余分なテキストを削除します（例：「1 EA628W-25B」→「EA628W-25B」）
2. 前処理された型番ごとに、Amazon APIを使用して商品情報を取得します
3. 取得した商品情報（商品名、特徴、説明など）を使用して、Perplexity AIで最適な検索キーワードを生成します
4. 商品情報が取得できない場合は、型番のみを使用してキーワードを生成します

この多段階のプロセスにより、より正確で関連性の高い検索キーワードを生成することができます。

## 使用方法

### APIエンドポイント

#### 1. 一括キーワード生成

```
POST /search/batch-keywords
```

リクエスト例:
```json
{
  "model_numbers": [
    "EA628W-25B", 
    "1. EA715SE-10", 
    "型番: EA628PP-35"
  ],
  "custom_prompt": "下記の商品情報から重要なキーワードを組み合わせて表現を変えて類似品を検索しやすいように検索キーワードを作成してください。商品の情報や特徴を組み合わせて重要な検索キーワードを１個抽出してください。出力は商品名＋商品の特徴＋サイズや重量は近いものでお願いします。既存のメーカーを選定しないように、メーカー名、型番は記載しないようにお願いします。\n\n型番: {model_number}"
}
```

レスポンス例:
```json
{
  "results": [
    {
      "model_number": "EA628W-25B",
      "keyword": "精密ピンセット 先端幅広タイプ ステンレス製"
    },
    {
      "model_number": "EA715SE-10",
      "keyword": "デジタル温度計 防水型 高精度"
    },
    {
      "model_number": "EA628PP-35",
      "keyword": "精密ピンセット 先細タイプ 35mm"
    }
  ]
}
```

注意：
- 型番の前に番号（例：「1. EA715SE-10」）や「型番:」などのプレフィックスがついていても、自動的に削除されます。
- プロンプトの一部と思われるテキスト（「下記の商品」「検索キーワード」など）は型番として認識されません。

#### 2. 既存の検索キーワード最適化エンドポイント（互換性のため維持）

```
POST /search/enhance-keywords
```

リクエスト例:
```json
{
  "product_info_list": ["EA628W-25B", "EA715SE-10", "EA628PP-35"],
  "custom_prompt": "下記の商品名、型番、仕様情報から重要なキーワードを組み合わせて表現を変えて類似品を検索しやすいように検索キーワードを作成してください。商品の情報や特徴を組み合わせて重要な検索キーワードを１個抽出してください。出力は商品名＋商品の特徴＋サイズや重量は近いものでお願いします。既存のメーカーを選定しないように、メーカー名、型番は記載しないようにお願いします。\n\n型番: {model_number}"
}
```

レスポンス例:
```json
{
  "keywords": [
    "精密ピンセット 先端幅広タイプ ステンレス製",
    "デジタル温度計 防水型 高精度",
    "精密ピンセット 先細タイプ 35mm"
  ]
}
```

### コマンドラインツール

バックエンドディレクトリにある `batch_search.py` スクリプトを使用して、コマンドラインから一括キーワード生成を実行することもできます。

```bash
cd backend
python batch_search.py -i model_numbers.txt -o results.json
```

オプション：
- `-i, --input FILE` - 型番リストのファイル（1行に1つの型番）
- `-o, --output FILE` - 結果の出力ファイル（デフォルト: keywords_output.json）
- `-p, --prompt FILE` - カスタムプロンプトファイル（オプション）
- `-m, --models` - 型番を直接指定（カンマ区切り）

例：
```bash
# ファイルから型番を読み込む
python batch_search.py -i model_numbers.txt -o results.json

# 型番を直接指定する
python batch_search.py -m "EA628W-25B,EA715SE-10,EA628PP-35" -o results.json

# カスタムプロンプトを使用する
python batch_search.py -i model_numbers.txt -p custom_prompt.txt -o results.json
```

注意：
- 型番の前に番号（例：「1. EA715SE-10」）や「型番:」などのプレフィックスがついていても、自動的に削除されます。
- プロンプトの一部と思われるテキスト（「下記の商品」「検索キーワード」など）は型番として認識されません。

## フロントエンド

フロントエンドには、一括キーワード生成のための専用ページが追加されています。

URL: `/tools/batch-keywords`

このページでは、以下の機能が利用できます：
- 複数の型番を入力して一括でキーワードを生成
- カスタムプロンプトの設定
- 生成結果のCSVエクスポート

## 技術的な詳細

### BatchKeywordGenerator クラス

`src/tools/batch_keyword_generator.py` に実装されている `BatchKeywordGenerator` クラスが、キーワード生成の中核となる機能を提供しています。

主なメソッド：
- `generate_keyword(model_number, custom_prompt=None)` - 単一の型番からキーワードを生成
- `batch_generate(model_numbers, custom_prompt=None)` - 複数の型番から一括でキーワードを生成

### 環境設定

Perplexity AIのAPIキーは、`.env` ファイルに設定する必要があります：

```
PERPLEXITY_API_KEY=your_api_key_here
```

## トラブルシューティング

1. APIキーが設定されていない場合：
   - `.env`ファイルが正しく設定されているか確認してください。

2. APIエラーが発生した場合：
   - Perplexity APIの利用制限に達していないか確認してください。
   - インターネット接続を確認してください。

3. 入力ファイルが読み込めない場合：
   - ファイルパスが正しいか確認してください。
   - ファイルのエンコーディングがUTF-8であることを確認してください。 